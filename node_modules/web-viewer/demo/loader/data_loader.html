<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <script type="text/javascript" src="../../libs/three.modify.js"></script>
    <script type="text/javascript" src="../../src/utils/BoxBufferGeometry.js"></script>
    <script type="text/javascript" src="../../src/utils/CylinderBufferGeometry.js"></script>
    <script type="text/javascript" src="../libs/stat.js"></script>
    <script type="text/javascript" src="../libs/OrbitControls.js"></script>
    <script type="text/javascript" src="BMDLoader.js"></script>
    <script type="text/javascript" src="../../src/loaders/SceneReader.js"></script>
    <script type="text/javascript" src="../../src/loaders/SymbolReader.js"></script>
    <script type="text/javascript" src="../../src/loaders/MeshReader.js"></script>
    <script type="text/javascript" src="../../src/loaders/MaterialReader.js"></script>
    <script type="text/javascript" src="../../src/loaders/IdReader.js"></script>

    <script type="text/javascript">
        var scene = null;
        var camera = null;
        var renderer = null;

        var id = null;
        var stat = null;
        var config = null;
        var loader = null;

        var theHost = "localhost";

        if (window.location.hostname)

        var url_str = "http://" + theHost + "/databag/CP23";
        var bAdd = true;

        function init() {

            // state
            stat = new Stats();
            stat.domElement.style.position = 'absolute';
            stat.domElement.style.right = '0px';
            stat.domElement.style.top = '0px';
            document.body.appendChild(stat.domElement);

            // render
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById( 'mainCanvas' )
            });

            // scene
            scene = new THREE.Scene();

            // camera
            camera = new THREE.PerspectiveCamera( 60, 800/600, 100, 5000000 );
            camera.position.set( 100000, 200000, 20000 );
            camera.up.set ( 0, 0, 10000 );
            camera.lookAt( new THREE.Vector3( 0, 0, 0 ) )
            scene.add(camera);

            // loader
            loadConfig( url_str );

            // light
            scene.add( new THREE.AmbientLight( 0x444444 ) );
            var light1 = new THREE.PointLight( 0xffffff, 1, 100);
            light1.position.set( 0, 0, 100000 );
            scene.add( light1 );

            var light2 = new THREE.PointLight( 0xffffff, 1, 100);
            light2.position.set( 0, 100000, 0 );
            scene.add( light2 );

            // UI
            var controls = new THREE.OrbitControls( camera, renderer.domElement );
            window.addEventListener( 'resize', onWindowResize, false );
            document.addEventListener( 'mousemove', onDocumentMouseMove, false );

            // draw
            draw();
        }

        function loadConfig ( url ) {

            var xmlRequest = new XMLHttpRequest();
            xmlRequest.onreadystatechange = readConfig;
            xmlRequest.open( "GET", url + "/config.json", true );
            xmlRequest.responseType = 'text';
            xmlRequest.send(null);
        }

        function readConfig( e ){

            if( e.target.readyState == 4 ){
                if( e.target.status == 200 ){
                    config = new Config( e.target.response );
                }
            }
        }

        function Config( text ) {

            var index = JSON.parse( text );
            this.scene_count = index.metadata.scenes;
            this.mpk_count = index.metadata.mpks;
            loader = new CLOUD.Loader.BMDLoader( this.scene_count, this.mpk_count );
            loadModel( url_str, this.scene_count, this.mpk_count );
        }

        function loadModel( url, scene_n, mpk_n ) {

            for( var i = 0; i < scene_n; ++i ) {

                loader.loadScene( url + "/scene/scene_" + i.toString() );
            }

            for( var j = 0; j < mpk_n; ++j ) {

                loader.loadMesh( url + "/mpk/mpk_" + j.toString() );
            }

                loader.loadSymbol( url + "/symbol/symbol" );
                loader.loadMaterial( url + "/material/material" );
                loader.loadSceneID( url + "/scene/scene_id" );
                loader.loadMeshID( url + "/mpk/mesh_id" );
                loader.loadMaterialID( url + "/material/material_id" );
            }

        function draw() {

            if( ( loader != undefined )
                    && ( config != undefined )
                    && ( loader.material != undefined )
                    && ( loader.sceneArray.length == config.scene_count )
                    && bAdd ) {

                var i = 0;
                for( i = 0; i < config.mpk_count; ++i ) {
                    if( loader.mpkArray[i] == undefined ){
                        break;
                    }
                }

                if( i == config.mpk_count ) {
                    loader.readScene( 0, function ( mesh ) {
                        scene.add( mesh );
                    });

                    bAdd = false;
                }
            }

            stat.update();
            renderer.render( scene, camera );
            requestAnimationFrame( draw );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function onDocumentMouseMove( event ) {
            event.preventDefault();
        }

    </script>
</head>

<body onload="init()">
<canvas id="mainCanvas" width="800px" height="600px" ></canvas>
</body>
</html>